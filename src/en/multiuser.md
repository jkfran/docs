Title: Using Juju with multiple users
TODO: Stuff on user-added models (ssh key and credentials)
      Check the functionality of admin user access level. This currently appears to do nothing (not destroy models, nor backups) 

# Using Juju with multiple users

Juju has an internal user framework that allows for the sharing of controllers
and models. To achieve this, a Juju user can be created that is of a certain
type; be granted specific permissions; and be authenticated in a certain way.

[Machine SSH authentication][users-auth]

## Creating users

There are two ways users are introduced into Juju:

 1. via the `bootstrap` command, which creates the initial controller
    administrator
 1. via the `add-user` command, which creates a generic user 
 
The second sets up a password but the first is left without one. This is why if
such an admin tries to log out (`logout`) before creating a password the
command will fail and a warning will be displayed. An admin should, therefore,
create a password once the controller is created:

```bash
juju bootstrap aws
juju change-user-password
```

In a Juju context, the term "credential" is related to the accessing of a
chosen backing cloud, and not to Juju users. See [Credentials][credentials] for
further clarification.

[User types][users]

### Creating a generic user

When the `add-user` command is used, a string of text is produced that encodes
information about the user and the controller. This string is supplied to the
intended operator who will use it to *register* the controller using their own
Juju client.

The user will be asked to enter an arbitrary (but hopefully meaningful) name to
the controller as well as create a password for themselves. The controller name
needs to be unique within the context of the client. The user's password is
stored on the controller.

!!! Note: 
    Controller registration (and any other Juju operations that involves
    communication between a client and a controller) necessitates the client be
    able to contact the controller over the network on TCP port 17070. In
    particular, if using a LXD-based cloud, network routes need to be in place
    (i.e. to contact the controller LXD container the client traffic must be
    routed through the LXD host).

To create user 'mat' the controller administrator uses the `add-user` command:

```bash
juju add-user mat
```

This will produce output similar to:

```no-highlight
User "mat" added
Please send this command to mat:
    juju register ME0TA21hdDAWExQxMC4xNDkuMTMzLjIwOToxNzA3MAQg7D-RDR8cnioqd7ctEoCjyDzaprK4wXodvfMBBrgBUKETDGx4ZC1iaW9uaWMtMQAA

"mat" has not been granted access to any models. You can use "juju grant" to grant access.
```

The administrator provides the command (manually) to the intended operator, who
will execute it:

```bash
juju register ME0TA21hdDAWExQxMC4xNDkuMTMzLjIwOToxNzA3MAQg7D-RDR8cnioqd7ctEoCjyDzaprK4wXodvfMBBrgBUKETDGx4ZC1iaW9uaWMtMQAA
```

Sample user session:


```no-highlight
Enter a new password: 
Confirm password: 
Enter a name for this controller [lxd-bionic-1]: lxd-bionic-1
Initial password successfully set for mat.

Welcome, mat. You are now logged into "lxd-bionic-1".

There are no models available. You can add models with
"juju add-model", or you can ask an administrator or owner
of a model to grant access to that model with "juju grant".
```

The name of the original controller, in this case 'lxd-bionic-1', is offered as
a default controller name.

#### Lost registration string

If a situation occurs where the registering token fails to work for some
reason, or is lost, a new token can be generated by the admin user with the
`change-user-password` command. For example, to generate a new token for 'jon',
the admin user can use this command with the '--reset' switch:

```bash
juju change-user-password jon --reset
```

The previous token will now be invalid, and the user should register with
the new token.

## Managing models in a multi-user context

The model creator becomes, by default, the model owner. However, the creation
process does allow for owner designation. To add model 'arena' and designate
user 'tron' as the owner:

```bash
juju add-model --owner=tron arena
```

See the [Adding a model][models-adding] page for the basics on adding models.

If two users, say 'jane' and 'claire', each have a model with the same name,
'foo', these models can be queried using the notation `{owner}/{model}`,
instead of just the model name. For example, 'claire' can get the status of the
model belonging to 'jane' in this way:

```bash
juju status -m jane/foo
```

### Models and user access

An administrator can use the `grant` command to give a user 'read', 'write',
or 'admin' access to a model. 

 - `read`: A user can view the state of a model (e.g. `models`, `machines`, and
   `status`)
 - `write`: In addition to 'read' abilities, a user can modify/configure models
   (e.g. `model-config` and `model-defaults`).
 - `admin`: In addition to 'write' abilities, a user can perform model upgrades
   (`upgrade-model`) and connect to machines via `juju ssh`. Makes the user an
   effective model owner.

Here we give 'bob' write access to model 'genesis':

```bash
juju grant bob write genesis
```

See [Users][regularusers] for details on available commands.

### Controller access

A controller actually refers to a special kind of model that acts as the
nucleus for each cloud environment. Properly managed access to any controller
is critical to the security and stability of all its workload models. 

In addition to the two levels of user access for models, three further levels
of access are used to manage access to a controller:

 - `login`: the standard access level for any user, enabling them to log in to
   a controller.
 - `add-model`: in addition to login access, a user is also be permitted to add
   and remove models.
 - `superuser`: makes a user an effective controller administrator.

The command syntax for controller access is the same as for model access, only
without the need to specify a model. As usual, with no controller specified via
the `-c` option, the current controller will be assumed the target.

Here we give 'jim' the 'add-model' permission:

```bash
juju grant jim add-model
```

The `users` command can be used to list all users registered to a controller,
along with their access levels. The output will look similar to the following:

```no-highlight
Controller: admin-lxd

Name    Display name  Access     Date created  Last connection
admin*  admin         superuser  2016-11-14    just now
bob                   login      1 hour ago    58 minutes ago
jim                   add-model  2016-11-14    58 minutes ago
```


<!-- LINKS -->

[users]: ./users.md
[users-auth]: ./users-auth.md
