Title: Using Juju with multiple users
TODO: Stuff on user-added models (ssh key and credentials)
      Check the functionality of admin user access level. This currently appears to do nothing (not destroy models, nor backups) 

# Using Juju with multiple users

Juju has an internal user framework that allows for the sharing of controllers
and models. To achieve this, a Juju user can be created that is of a certain
type; be granted specific permissions; and be authenticated in a certain way.

[Machine SSH authentication][users-auth]

## Creating users

There are two ways users are introduced into Juju:

 1. via the `bootstrap` command, which creates the initial controller
    administrator
 1. via the `add-user` command, which creates a generic user 
 
The second sets up a password but the first is left without one. This is why if
such an admin tries to log out (`logout`) before creating a password the
command will fail and a warning will be displayed. An admin should, therefore,
create a password once the controller is created:

```bash
juju bootstrap aws
juju change-user-password
```

In a Juju context, the term "credential" is related to the accessing of a
chosen backing cloud, and not to Juju users. See [Credentials][credentials] for
further clarification.

[User types][users]

### Creating a generic user

When the `add-user` command is used, a string of text is produced that encodes
information about the user and the controller. This string is supplied to the
intended operator who will use it to *register* the controller using their own
Juju client.

The user will be asked to enter an arbitrary (but hopefully meaningful) name to
the controller as well as create a password for themselves. The controller name
needs to be unique within the context of the client. The user's password is
stored on the controller.

!!! Note: 
    Controller registration (and any other Juju operations that involves
    communication between a client and a controller) necessitates the client be
    able to contact the controller over the network on TCP port 17070. In
    particular, if using a LXD-based cloud, network routes need to be in place
    (i.e. to contact the controller LXD container the client traffic must be
    routed through the LXD host).

To create user 'mat' the controller administrator uses the `add-user` command:

```bash
juju add-user mat
```

This will produce output similar to:

```no-highlight
User "mat" added
Please send this command to mat:
    juju register ME0TA21hdDAWExQxMC4xNDkuMTMzLjIwOToxNzA3MAQg7D-RDR8cnioqd7ctEoCjyDzaprK4wXodvfMBBrgBUKETDGx4ZC1iaW9uaWMtMQAA

"mat" has not been granted access to any models. You can use "juju grant" to grant access.
```

The administrator provides the command (manually) to the intended operator, who
will execute it:

```bash
juju register ME0TA21hdDAWExQxMC4xNDkuMTMzLjIwOToxNzA3MAQg7D-RDR8cnioqd7ctEoCjyDzaprK4wXodvfMBBrgBUKETDGx4ZC1iaW9uaWMtMQAA
```

Sample user session:


```no-highlight
Enter a new password: 
Confirm password: 
Enter a name for this controller [lxd-bionic-1]: lxd-bionic-1
Initial password successfully set for mat.

Welcome, mat. You are now logged into "lxd-bionic-1".

There are no models available. You can add models with
"juju add-model", or you can ask an administrator or owner
of a model to grant access to that model with "juju grant".
```

The name of the original controller, in this case 'lxd-bionic-1', is offered as
a default controller name.

## Disabling and re-enabling users

To immediately sever a user's communication with their controller the
`disable-user` command is employed. To re-establish communication the
`enable-user` command is used.

To disable the user 'mike':

```bash
juju disable-user mike
```

To re-enable:

```bash
juju enable-user mike
```

Disabled users are suppressed in the output to the `users` command unless the
`--all` option is used, whereby the output will show "disabled":

```no-highlight
Controller: cstack

Name    Display name  Access     Date created    Last connection
admin*  admin         superuser  2018-12-12      just now
mike                  login      17 minutes ago  never connected (disabled)
```

## Changing user passwords

A user is prompted to set a password when registering a controller. This
password can subsequently be changed either by the user himself or by the
controller admin. For the user, it is simply a matter of running:

```bash
juju change-user-password
```

The admin user supplies the name of the user whose password is to be changed:

```bash
juju change-user-password mike
```

Then simply follow the prompts to enter and confirm a new password.

## Re-generating a lost registration string

If the original registering token fails to work or is lost a new token can be
generated by the controller admin. This is done through the use of the
`--reset` option in conjunction with the `change-user-password` command. For
example, to generate a new token for 'jon':

```bash
juju change-user-password jon --reset
```

The previous token will be invalidated, and the user should register with the
new token.

## Managing models in a multi-user context

In this section we go over the various ways models can be managed in a
multi-user context.

### Providing model ownership during model creation

The model creator becomes, by default, the model owner. However, the creation
process does allow for owner designation. To add model 'arena' and designate
user 'tron' as the owner:

```bash
juju add-model --owner=tron arena
```

See the [Adding a model][models-adding] page for the basics on adding models.

### Models access

A controller admin uses the `grant` command to give a user 'read', 'write', or
'admin' access to a model: 

 - `read`: A user can view the state of a model (e.g. `models`, `machines`, and
   `status`)
 - `write`: In addition to 'read' abilities, a user can modify/configure models
   (e.g. `model-config` and `model-defaults`).
 - `admin`: In addition to 'write' abilities, a user can perform model upgrades
   (`upgrade-model`) and connect to machines via `juju ssh`. Makes the user an
   effective model owner. See [Model owners][users-owners] for commands
   available to such a user.

Here we give 'bob' write access to model 'genesis':

```bash
juju grant bob write genesis
```

Current model access for a user can be viewed by specifying the user with the
`models` command. Here we inspect the access enjoyed by user 'mat':

```bash
juju models --user mat
```

Sample output:

```no-highlight
Controller: lxd-bionic-1

Model            Cloud/Region         Status     Access  Last connection
admin/euphoric*  localhost/localhost  available  read    never connected
```

Access can be viewed on a per-model basis by using the `show-model` command.
Here we query model 'mara':

```bash
juju show-model mara
```

Partial output:

```no-highlight
 users:
    admin:
      display-name: admin
      access: admin
      last-connection: never connected
    jim:
      access: write
      last-connection: never connected
    pete:
      access: admin
      last-connection: never connected
```

### Controller access

A controller actually refers to a special kind of model that acts as the
nucleus for each cloud environment. In addition to the three levels of model
access, three further levels of access are available for managing access to a
controller:

 - `login`: the standard access level, enabling a user to log in to a
   controller.
 - `add-model`: in addition to login access, a user can add and remove models.
 - `superuser`: makes a user an effective controller administrator. See
   [Controller administrators][users-admins] for commands available to such a
   user.

The command syntax for controller access is the same as for model access, only
without the need to specify a model. As usual, with no controller specified via
the `-c` option, the current controller will be assumed the target.

Here we give 'jim' the 'add-model' permission:

```bash
juju grant jim add-model
```

Current controller access for all users registered to the controller can be
viewed with the `users` command:

```no-highlight
Controller: admin-lxd

Name    Display name  Access     Date created  Last connection
admin*  admin         superuser  2018-12-14    just now
bob                   login      1 hour ago    50 minutes ago
jim                   add-model  2018-12-14    58 minutes ago
```


<!-- LINKS -->

[users]: ./users.md
[users-auth]: ./users-auth.md
[users-owners]: ./users.md#model-owners
[users-admins]: ./users.md#controller-administrators
